---
layout:     post
title:      "python之异步函数添加装饰器"
subtitle:   
date:       2023-08-27
author:     胖胖很瘦
thumbnail:  /images/5e931aa5/thumbnail.png
catalog: true
categories: python
original_url: https://mp.weixin.qq.com/s/PUtAsSDfOaPb_rR0SAS4BQ
tags:
    - python
    - 装饰器
    - py小白
---

![](/images/5e931aa5/1.png)

废话

        在前面文章中讲了装饰器, 但是都是装饰器作用在同步函数上, 如果是异步函数就会有问题, 因为异步函数需要async关键字声明, 同时需要使用await在调用, 所以需要让装饰器支持作用在异步函数上

代码

关于装饰器可以看前面的文章, 链接放文尾, 直接上代码

```
# -*- coding: utf-8 -*-  
# @Author: Mehaei  
# @Date: 2023-08-27 10:36:16  
# @Last Modified by: Mehaei  
# @Last Modified time: 2023-08-27 12:33:45  
import asyncio  
import time  
import functools  
  
  
def exec_time(func):  
    """  
    统计函数耗费时间函数  
    """  
    @functools.wraps(func)  
    async def async_warp(*args, **kwargs):  
        st = time.time()  
        result = await func(*args, **kwargs)  
        print(f"{func.__name__} spend {time.time() - st}")  
        return result  
  
    @functools.wraps(func)  
    def sync_warp(*args, **kwargs):  
        st = time.time()  
        result = func(*args, **kwargs)  
        print(f"{func.__name__} spend {time.time() - st}")  
        return result  
    # 判断函数是否为异步函数  
    if asyncio.iscoroutinefunction(func):  
        return async_warp  
    else:  
        return sync_warp  
  
  
@exec_time  
async def async_func():  
    """  
    异步函数  
    """  
    await asyncio.sleep(1)  
    print("sleep done")  
  
  
@exec_time  
def sync_func():  
    """  
    同步函数  
    """  
    time.sleep(1)  
    print("sleep done")  
  
  
if __name__ == "__main__":  
    # 调用异步函数  
    asyncio.run(async_func())  
    # 调用同步函数  
    sync_func()
```

![](/images/5e931aa5/2.png)

结果输出

```
sleep done  
async_func spend 1.0007221698760986  
sleep done  
sync_func spend 1.0049903392791748  
[Finished in 2.1s]
```

总结

        其中async\_func是异步函数, 使用syncio.run来执行, sync\_func是一个同步函数, 直接执行即可,  asyncio.iscoroutinefunction 是判断是不是异步函数, 异步函数则使用异步装饰器, 同步函数就使用同步装饰器, 这样就实现了一个既支持同步函数, 又支持异步的一个装饰器

相关推荐

[python装饰器](http://mp.weixin.qq.com/s?__biz=MzUyMzk3OTYyMQ==&mid=2247487309&idx=1&sn=1ae372f560d3950a07a9c71039c97802&chksm=fa351147cd4298513b506fac7fbbd1cb6aec250a672b9b2ec8b99677ad77420af6df715a0144&scene=21#wechat_redirect)

[python异常处理](http://mp.weixin.qq.com/s?__biz=MzUyMzk3OTYyMQ==&mid=2247487233&idx=1&sn=44a52d31332103d2290ef7e4fa23cadc&chksm=fa35110bcd42981d1d0f4efdbd363e3f5dbec2f0db1d231635aff045b0d9f2a1818730189718&scene=21#wechat_redirect)

[python类的常用魔术方法](http://mp.weixin.qq.com/s?__biz=MzUyMzk3OTYyMQ==&mid=2247487222&idx=1&sn=fd2349cb8902e40f41f7568d3ccefedd&chksm=fa3510fccd4299eadd597f56ef5912c334b79642eddb88fe7b5e9cf0b3e7655d9590a2234e18&scene=21#wechat_redirect)

[python模块导入及导出](http://mp.weixin.qq.com/s?__biz=MzUyMzk3OTYyMQ==&mid=2247487329&idx=1&sn=b09e74cb74f908a1c9a80f46ef63e4e9&chksm=fa35116bcd42987d7f4c186d579da627db92e3b26f892a83d0367ca8659c44260fb7e924d343&scene=21#wechat_redirect)