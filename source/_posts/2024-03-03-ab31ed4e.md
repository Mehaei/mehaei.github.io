---
layout:     post
title:      "mongo高阶操作之数据不存在插入存在则更新（pymongo）"
subtitle:   
date:       2024-03-03
author:     胖胖很瘦
thumbnail:  /images/ab31ed4e/thumbnail.png
catalog: true
categories: python高级
original_url: https://mp.weixin.qq.com/s/QDCW_XuswNPnuAXJFM9jjQ
tags:
    - pymongo
    - python高级
---
![](/images/ab31ed4e/1.png)

**一、开始**

`mongo`特别适合存储各种嵌套及不能确定格式的数据，而`mongo`自带的去重功能（使用 `_id`唯一键支持）又特别适合小爬虫存储数据。多数情况会出现数据更新的操作， 但又不知道是不是存在， 是使用`insert`还是`update`。看到最后就知道了， 还可以存在则更新部分字段， 不存在则插入。废话不多说， 开干。

#### 

#### **二、测试数据**

```
datas = [  
      {  
          "_id": 1,  
          "insert_time": time.time(),  
          "update_time": time.time(),  
          "name": "zs"  
      },  
      {  
          "_id": 2,  
          "insert_time": time.time(),  
          "update_time": time.time(),  
          "name": "ls"  
      },  
      {  
          "_id": 3,  
          "insert_time": time.time(),  
          "update_time": time.time(),  
          "name": "ww"  
      },  
  ]
```

#### **三、示例**

以下代码实现：

1、实现存在更新不存在则插入

2、实现存在跳过不存在则插入

3、实现存在更新部分字段不存在则插入

就不分开写了， 直接放在一个源文件里了， 最后有测试用例

![](/images/ab31ed4e/2.png)

```
# -*- coding: utf-8 -*-  
  
# @Author: 胖胖很瘦  
# @Date: 2024-03-03 12:58:42  
# @LastEditors: 胖胖很瘦  
# @LastEditTime: 2024-03-03 13:57:49  
  
# 导入包  
import time  
from pymongo import MongoClient as MC  
from pymongo import UpdateOne  
client = MC()["test"]  
  
  
def exists_update_and_insert(data, bulk=False):  
    """  
    存在则更新  
    不存在则插入  
    :param data: 数据  
    :param bulk: 是否使用批量插入  
    # ordered  
    # 有序执行, 一条报错, 后面不再执行  
    # 无序执行, 一条报错, 其它不受影响  
    """  
  
    if bulk:  
        bulk_docs = []  
        for rd in data:  
            bulk_docs.append(  
                UpdateOne(  
                    {"_id": rd["_id"]},  
                    {"$set": rd},  
                    upsert=True  
                ))  
        result = client['goods'].bulk_write(bulk_docs, ordered=False).bulk_api_result  
        print(result)  
    else:  
        for rd in data:  
            client['goods'].update_one(  
                {'_id': rd['_id']},   
                {'$set': rd},   
                upsert=True  
            )  
  
  
def exists_do_noting_and_insert(data, bulk=False):  
    """  
    存在则不做任何操作  
    不存在则插入  
    :param data: 数据  
    :param bulk: 是否使用批量插入  
    """  
  
    if bulk:  
        bulk_docs = []  
        for rd in data:  
            bulk_docs.append(  
                UpdateOne(  
                    {"_id": rd["_id"]},  
                    {"$setOnInsert": rd},  
                    upsert=True  
                ))  
        result = client['goods'].bulk_write(bulk_docs, ordered=False).bulk_api_result  
        print(result)  
    else:  
        for rd in data:  
            client['goods'].update_one(  
                {'_id': rd['_id']},   
                {'$setOnInsert': rd},   
                upsert=True  
            )  
  
  
def exists_update_any_field_and_insert(data, bulk=False):  
    """  
    存在则更新部分字段  
    不存在则插入  
    :param data: 数据  
    :param bulk: 是否使用批量插入  
    """  
  
    if bulk:  
        bulk_docs = []  
        for rd in data:  
            update_time = rd.pop("update_time", time.time())  
            bulk_docs.append(  
                UpdateOne(  
                    {"_id": rd["_id"]},  
                    {  
                        "$setOnInsert": rd,  
                        "$set": {"update_time": update_time}  
                    },  
                    upsert=True  
                ))  
        result = client['goods'].bulk_write(bulk_docs, ordered=False).bulk_api_result  
        print(result)  
    else:  
        for rd in data:  
            update_time = rd.pop("update_time", time.time())  
            client['goods'].update_one(  
                {'_id': rd['_id']},  
                {  
                    '$setOnInsert': rd,  
                    "$set": {"update_time": update_time}  
                },  
                upsert=True  
            )  
  
  
def find(query=None):  
    """  
    查询数据  
    :query: 查询条件  
    """  
    return list(client['goods'].find(query))  
  
  
def remove(query=None):  
    """  
    删除数据  
    :query: 删除条件  
    """  
    return client["goods"].remove(query)  
  
  
if __name__ == '__main__':  
    # 测试数据  
    datas = [  
        {  
            "_id": 1,  
            "insert_time": time.time(),  
            "update_time": time.time(),  
            "name": "zs"  
        },  
        {  
            "_id": 2,  
            "insert_time": time.time(),  
            "update_time": time.time(),  
            "name": "ls"  
        },  
        {  
            "_id": 3,  
            "insert_time": time.time(),  
            "update_time": time.time(),  
            "name": "ww"  
        },  
    ]  
  
    """  
    测试用例  
    """  
    # exists_update_and_insert(datas)  
    # exists_update_and_insert(datas, True)  
    # print(find())  
    # remove()  
  
    # exists_do_noting_and_insert(datas)  
    # exists_do_noting_and_insert(datas, True)  
    # print(find())  
    # remove()  
  
  
    # exists_update_any_field_and_insert(datas)  
    # exists_update_any_field_and_insert(datas, True)  
    # print(find())  
    # remove()
```

#### **四、完事**

文字虽然少， 但是干货满满。周末快乐， 留下你的点赞吧～

精彩推荐

[mac管理git项目更新RSA SSH 主机密钥](http://mp.weixin.qq.com/s?__biz=MzUyMzk3OTYyMQ==&mid=2247488405&idx=1&sn=8fde23a52dbfbd7ea27158ddf62fc346&chksm=fa350d9fcd42848948b52d6c43653e632c1218689eabb4a6b2da081233de993103396cb9b54c&scene=21#wechat_redirect)

[MongoDB中的批量Upsert与$addToSet的高效使用](http://mp.weixin.qq.com/s?__biz=MzUyMzk3OTYyMQ==&mid=2247488399&idx=1&sn=0207e9004394b91d0c8a5e9301cfffeb&chksm=fa350d85cd428493e5d5f3155d0e3a3a8dfca09d7dc1c884f0e605d5f86e22231644d46a5c6b&scene=21#wechat_redirect)

[iOS中的Bark及Bark Server搭建、安装和使用全指南](http://mp.weixin.qq.com/s?__biz=MzUyMzk3OTYyMQ==&mid=2247488389&idx=1&sn=5a1b35d577fab581647c6bb7ae6c4c76&chksm=fa350d8fcd42849919e064964b8d96200d23eaef7ddba537ae8de6ed3309c0fce0304420b176&scene=21#wechat_redirect)

[WebSockets：实时通信的未来](http://mp.weixin.qq.com/s?__biz=MzUyMzk3OTYyMQ==&mid=2247488187&idx=1&sn=585263d38e92ae89cef5a21a83d8c526&chksm=fa350cb1cd4285a721501cb804e096a313e6dfa78f7c767f1999e5c4910d171b6d1422d6de45&scene=21#wechat_redirect)
